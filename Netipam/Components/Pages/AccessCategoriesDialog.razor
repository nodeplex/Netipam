@using MudBlazor
@using Microsoft.EntityFrameworkCore
@using Netipam.Data

@inject AppDbContext DbContext
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-3">
            <MudText Typo="Typo.h6">Access Categories</MudText>
            <MudSpacer />
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OpenAdd">
                Add Category
            </MudButton>
        </MudStack>

        <MudTable T="AccessCategory" Items="@categories" Dense="true" Hover="true" Bordered="true" Striped="true">
            <HeaderContent>
                <MudTh>Name</MudTh>
                <MudTh>Description</MudTh>
                <MudTh style="width:120px;"></MudTh>
            </HeaderContent>

            <RowTemplate Context="c">
                <MudTd DataLabel="Name">@c.Name</MudTd>
                <MudTd DataLabel="Description">@c.Description</MudTd>
                <MudTd DataLabel="Actions">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small"
                                   OnClick="@(() => OpenEdit(c.Id))" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small"
                                   OnClick="@(() => ConfirmDelete(c.Id))" />
                </MudTd>
            </RowTemplate>

            <NoRecordsContent>
                <MudText Typo="Typo.body2" Class="pa-4">No access categories yet.</MudText>
            </NoRecordsContent>
        </MudTable>
    </DialogContent>

    <DialogActions>
        <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="Close">
            Close
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = default!;

    private List<AccessCategory> categories = new();

    protected override async Task OnInitializedAsync()
        => await Reload();

    private async Task Reload()
    {
        categories = await DbContext.AccessCategories
            .AsNoTracking()
            .OrderBy(c => c.Name)
            .ToListAsync();
    }

    private void Close() => MudDialog.Close(DialogResult.Ok(true));

    private async Task OpenAdd()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = DialogService.Show<AddAccessCategoryDialog>("Add Access Category", options);
        var result = await dialog.Result;

        if (!result.Canceled)
            await Reload();
    }

    private async Task OpenEdit(int id)
    {
        var parameters = new DialogParameters { ["AccessCategoryId"] = id };
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = DialogService.Show<EditAccessCategoryDialog>("Edit Access Category", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
            await Reload();
    }

    private async Task ConfirmDelete(int id)
    {
        var inUse = await DbContext.Devices.AsNoTracking().AnyAsync(d => d.AccessCategoryId == id);
        if (inUse)
        {
            Snackbar.Add("Cannot delete: this category is assigned to one or more devices.", Severity.Warning);
            return;
        }

        var confirm = await DialogService.ShowMessageBox(
            title: "Delete access category?",
            message: "Are you sure you want to delete this access category?",
            yesText: "Delete",
            cancelText: "Cancel");

        if (confirm != true)
            return;

        var entity = await DbContext.AccessCategories.FirstOrDefaultAsync(c => c.Id == id);
        if (entity is null)
            return;

        DbContext.AccessCategories.Remove(entity);
        await DbContext.SaveChangesAsync();

        Snackbar.Add("Access category deleted.", Severity.Success);
        await Reload();
    }
}
