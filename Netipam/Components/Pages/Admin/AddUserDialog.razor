@using Microsoft.AspNetCore.Identity
@using MudBlazor
@using Netipam.Data

@inject UserManager<ApplicationUser> UserManager
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudStack Spacing="2">
            <MudTextField @bind-Value="username" Label="Username" Immediate="true" />
            <MudTextField @bind-Value="password" Label="Password" InputType="InputType.Password" Immediate="true" />
            <MudSelect T="string" Label="Role" @bind-Value="role" Dense="true">
                @foreach (var r in AllRoles)
                {
                    <MudSelectItem Value="@r">@r</MudSelectItem>
                }
            </MudSelect>
        </MudStack>
    </DialogContent>

    <DialogActions>
        <MudButton Variant="Variant.Text" OnClick="Cancel">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Create" Disabled="@busy">
            Create
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] public IMudDialogInstance MudDialog { get; set; } = default!;
        
    //[CascadingParameter] MudDialogInstance MudDialog { get; set; } = default!;

    [Parameter] public List<string> AllRoles { get; set; } = new();

    private string? username;
    private string? password;
    private string? role;
    private bool busy;

    private void Cancel() => MudDialog.Cancel();

    private async Task Create()
    {
        if (busy) return;
        busy = true;

        try
        {
            var u = new ApplicationUser { UserName = (username ?? "").Trim() };
            var res = await UserManager.CreateAsync(u, password ?? "");
            if (!res.Succeeded)
            {
                Snackbar.Add(string.Join(" | ", res.Errors.Select(e => e.Description)), Severity.Error);
                return;
            }

            if (!string.IsNullOrWhiteSpace(role))
                await UserManager.AddToRoleAsync(u, role);

            MudDialog.Close(DialogResult.Ok(true));
        }
        finally
        {
            busy = false;
        }
    }
}
