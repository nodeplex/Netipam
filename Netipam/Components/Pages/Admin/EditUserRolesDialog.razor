@using Microsoft.AspNetCore.Identity
@using MudBlazor
@using MudBlazor.Components
@using Netipam.Data

@inject UserManager<ApplicationUser> UserManager
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudStack Spacing="2">
            <MudText Typo="Typo.subtitle1">@Username</MudText>

            @foreach (var r in AllRoles)
            {
                <MudCheckBox T="bool"
                             Label="@r"
                             Value="@selected.Contains(r)"
                             ValueChanged="@((bool v) => Toggle(r, v))" />
            }
        </MudStack>
    </DialogContent>

    <DialogActions>
        <MudButton Variant="Variant.Text" OnClick="Cancel">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Save" Disabled="@busy">
            Save
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] public IMudDialogInstance MudDialog { get; set; } = default!;
    //[CascadingParameter] MudDialogInstance MudDialog { get; set; } = default!;

    [Parameter] public string UserId { get; set; } = "";
    [Parameter] public string Username { get; set; } = "";
    [Parameter] public List<string> AllRoles { get; set; } = new();
    [Parameter] public List<string> CurrentRoles { get; set; } = new();

    private HashSet<string> selected = new(StringComparer.OrdinalIgnoreCase);
    private bool busy;

    protected override void OnInitialized()
    {
        selected = new HashSet<string>(CurrentRoles ?? new(), StringComparer.OrdinalIgnoreCase);
    }

    private void Toggle(string role, bool value)
    {
        if (value) selected.Add(role);
        else selected.Remove(role);
    }

    private void Cancel() => MudDialog.Cancel();

    private async Task Save()
    {
        if (busy) return;
        busy = true;

        try
        {
            var user = await UserManager.FindByIdAsync(UserId);
            if (user is null) { Snackbar.Add("User not found.", Severity.Error); return; }

            var current = await UserManager.GetRolesAsync(user);

            var toAdd = selected.Except(current, StringComparer.OrdinalIgnoreCase).ToList();
            var toRemove = current.Except(selected, StringComparer.OrdinalIgnoreCase).ToList();

            if (toRemove.Count > 0) await UserManager.RemoveFromRolesAsync(user, toRemove);
            if (toAdd.Count > 0) await UserManager.AddToRolesAsync(user, toAdd);

            MudDialog.Close(DialogResult.Ok(true));
        }
        finally
        {
            busy = false;
        }
    }
}

