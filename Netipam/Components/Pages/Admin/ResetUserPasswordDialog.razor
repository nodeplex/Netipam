@using Microsoft.AspNetCore.Identity
@using MudBlazor
@using MudBlazor.Components
@using Netipam.Data

@inject UserManager<ApplicationUser> UserManager
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudStack Spacing="2">
            <MudText Typo="Typo.subtitle1">Reset password for @Username</MudText>
            <MudTextField @bind-Value="newPassword" Label="New password" InputType="InputType.Password" Immediate="true" />
        </MudStack>
    </DialogContent>

    <DialogActions>
        <MudButton Variant="Variant.Text" OnClick="Cancel">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Reset" Disabled="@busy">
            Reset
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] public IMudDialogInstance MudDialog { get; set; } = default!;

    //[CascadingParameter] MudDialogInstance MudDialog { get; set; } = default!;

    [Parameter] public string UserId { get; set; } = "";
    [Parameter] public string Username { get; set; } = "";

    private string? newPassword;
    private bool busy;

    private void Cancel() => MudDialog.Cancel();

    private async Task Reset()
    {
        if (busy) return;
        busy = true;

        try
        {
            var user = await UserManager.FindByIdAsync(UserId);
            if (user is null) { Snackbar.Add("User not found.", Severity.Error); return; }

            var token = await UserManager.GeneratePasswordResetTokenAsync(user);
            var res = await UserManager.ResetPasswordAsync(user, token, newPassword ?? "");

            if (!res.Succeeded)
            {
                Snackbar.Add(string.Join(" | ", res.Errors.Select(e => e.Description)), Severity.Error);
                return;
            }

            MudDialog.Close(DialogResult.Ok(true));
        }
        finally
        {
            busy = false;
        }
    }
}

