@using MudBlazor
@using Microsoft.EntityFrameworkCore
@using Netipam.Data

@inject AppDbContext DbContext

<MudDialog>
    <DialogContent>
        @if (loading)
        {
            <MudProgressLinear Indeterminate="true" />
        }
        else if (location is null)
        {
            <MudAlert Severity="Severity.Error">Location not found.</MudAlert>
        }
        else
        {
            <MudStack Spacing="2">
                <MudTextField T="string"
                              Label="Name"
                              @bind-Value="location.Name"
                              Required="true"
                              RequiredError="Name is required."
                              Disabled="@busy" />

                <MudTextField T="string"
                              Label="Description"
                              @bind-Value="location.Description"
                              Lines="2"
                              Disabled="@busy" />
            </MudStack>
        }
    </DialogContent>

    <DialogActions>
        <MudButton Variant="Variant.Text"
                   Color="Color.Secondary"
                   OnClick="Cancel"
                   Disabled="@busy">
            Cancel
        </MudButton>

        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   OnClick="Save"
                   Disabled="@((busy) || (loading) || (location is null))">
            Save
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public int LocationId { get; set; }

    private Location? location;
    private bool loading = true;
    private bool busy;

    protected override async Task OnInitializedAsync()
    {
        location = await DbContext.Locations
            .FirstOrDefaultAsync(l => l.Id == LocationId);
        loading = false;
    }

    private void Cancel() => MudDialog.Cancel();

    private async Task Save()
    {
        if (location is null)
            return;

        if (busy) return;
        busy = true;

        try
        {
            if (string.IsNullOrWhiteSpace(location.Name))
                return;

            location.Name = location.Name.Trim();
            location.Description = location.Description?.Trim();

            await DbContext.SaveChangesAsync();
            MudDialog.Close(DialogResult.Ok(true));
        }
        finally
        {
            busy = false;
        }
    }
}
