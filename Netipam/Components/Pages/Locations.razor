@page "/locations"
@using MudBlazor
@using Microsoft.EntityFrameworkCore
@using Netipam.Data
@using Microsoft.AspNetCore.Components.Authorization

@inject AppDbContext DbContext
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthStateProvider

<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-3">
    <MudText Typo="Typo.h5">Locations</MudText>
    <MudSpacer />
    @if (_canEdit)
    {
        <MudIconButton Icon="@Icons.Material.Filled.AddBox"
                       Title="Add Location"
                       Size="Size.Medium"
                       Class="toolbar-button download-icon-btn add-icon"
                       OnClick="OpenAdd" />
    }
</MudStack>

<style>
    .download-icon-btn {
        height: 26px;
        width: 26px;
        padding: 0;
    }

    .add-icon {
        margin-right: 20px;
    }
</style>

<MudTable T="Location" Items="@locations" Dense="true" Hover="true" Bordered="true" Striped="true">
    <HeaderContent>
        <MudTh>Name</MudTh>
        <MudTh>Description</MudTh>
        <MudTh style="width:120px;">Assigned</MudTh>
        @if (_canEdit)
        {
            <MudTh style="width:120px;"></MudTh>
        }
    </HeaderContent>

    <RowTemplate Context="l">
        <MudTd DataLabel="Name">@l.Name</MudTd>
        <MudTd DataLabel="Description">@l.Description</MudTd>
        <MudTd DataLabel="Assigned">
            @if (assignedCounts.TryGetValue(l.Id, out var count) && count > 0)
            {
                <MudLink Href="@($"/locations/{l.Id}/devices")"
                         Underline="Underline.Always"
                         Style="font-size:inherit; font-weight:600">
                    @count
                </MudLink>
            }
            else
            {
                <span>0</span>
            }
        </MudTd>
        @if (_canEdit)
        {
            <MudTd DataLabel="Actions">
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small"
                               OnClick="@(() => OpenEdit(l.Id))" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small"
                               OnClick="@(() => ConfirmDelete(l.Id))" />
            </MudTd>
        }
    </RowTemplate>

    <NoRecordsContent>
        <MudText Typo="Typo.body2" Class="pa-4">No locations yet.</MudText>
    </NoRecordsContent>
</MudTable>

@code {
    private List<Location> locations = new();
    private Dictionary<int, int> assignedCounts = new();
    private bool _canEdit = true;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        _canEdit = !authState.User.IsInRole("Viewer");

        await Reload();
    }

    private async Task Reload()
    {
        locations = await DbContext.Locations
            .AsNoTracking()
            .OrderBy(l => l.Name)
            .ToListAsync();

        assignedCounts = await DbContext.Devices
            .AsNoTracking()
            .Where(d => d.LocationId != null || !string.IsNullOrWhiteSpace(d.Location))
            .GroupBy(d => d.LocationId)
            .Select(g => new { LocationId = g.Key, Count = g.Count() })
            .Where(x => x.LocationId != null)
            .ToDictionaryAsync(x => x.LocationId!.Value, x => x.Count);

        var legacyCounts = await DbContext.Devices
            .AsNoTracking()
            .Where(d => d.LocationId == null && !string.IsNullOrWhiteSpace(d.Location))
            .GroupBy(d => d.Location!.ToLower())
            .Select(g => new { Name = g.Key, Count = g.Count() })
            .ToListAsync();

        var legacyByName = legacyCounts.ToDictionary(x => x.Name, x => x.Count);

        foreach (var loc in locations)
        {
            if (legacyByName.TryGetValue(loc.Name.ToLower(), out var legacyCount))
            {
                assignedCounts[loc.Id] = assignedCounts.TryGetValue(loc.Id, out var current)
                    ? current + legacyCount
                    : legacyCount;
            }
        }
    }

    private async Task OpenAdd()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = DialogService.Show<AddLocationDialog>("Add Location", options);
        var result = await dialog.Result;

        if (!result.Canceled)
            await Reload();
    }

    private async Task OpenEdit(int id)
    {
        var parameters = new DialogParameters { ["LocationId"] = id };
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = DialogService.Show<EditLocationDialog>("Edit Location", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
            await Reload();
    }

    private async Task ConfirmDelete(int id)
    {
        var name = await DbContext.Locations
            .AsNoTracking()
            .Where(l => l.Id == id)
            .Select(l => l.Name)
            .FirstOrDefaultAsync();

        var inUse = await DbContext.Devices.AsNoTracking().AnyAsync(d =>
            d.LocationId == id ||
            (d.LocationId == null &&
             !string.IsNullOrWhiteSpace(name) &&
             !string.IsNullOrWhiteSpace(d.Location) &&
             d.Location!.ToLower() == name!.ToLower()));
        if (inUse)
        {
            Snackbar.Add("Cannot delete: this location is assigned to one or more devices.", Severity.Warning);
            return;
        }

        var confirm = await DialogService.ShowMessageBox(
            title: "Delete location?",
            message: "Are you sure you want to delete this location?",
            yesText: "Delete",
            cancelText: "Cancel");

        if (confirm != true)
            return;

        var entity = await DbContext.Locations.FirstOrDefaultAsync(l => l.Id == id);
        if (entity is null)
            return;

        DbContext.Locations.Remove(entity);
        await DbContext.SaveChangesAsync();

        Snackbar.Add("Location deleted.", Severity.Success);
        await Reload();
    }
}
